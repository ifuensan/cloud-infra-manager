# AWS Infrastructure Scripts

Scripts to manage EC2 infrastructure in AWS in an automated way.

## Available Scripts

### 1. create-aws-infra.sh

Creates all necessary infrastructure in AWS.

**Usage:**
```bash
./create-aws-infra.sh
```

**Configuration (edit the script):**
```bash
AWS_REGION="us-east-1"          # AWS region
KEY_NAME="peer-observer-key"    # Key pair name
INSTANCE_TYPE_NODE="t3.large"   # Type for Bitcoin node (2 vCPU, 8 GB RAM)
INSTANCE_TYPE_WEB="t3.medium"   # Type for webserver (2 vCPU, 4 GB RAM)
BITCOIN_VOLUME_SIZE=1000        # GB for blockchain
WEB_VOLUME_SIZE=100             # GB for webserver
```

**Resources it creates:**
- ✅ Security Group for nodes (Bitcoin)
  - Port 22 (SSH) from your IP
  - Port 8333 (Bitcoin P2P) open
  - Port 51820 (WireGuard) open
- ✅ Security Group for webserver
  - Port 22 (SSH) from your IP
  - Port 80 (HTTP) open
  - Port 443 (HTTPS) open
  - Port 51820 (WireGuard) open
- ✅ EC2 instance node01 (Bitcoin)
  - 50 GB root volume (gp3, DeleteOnTermination: true)
  - 1000 GB additional volume (gp3, DeleteOnTermination: false)
- ✅ EC2 instance web01 (Dashboard)
  - 100 GB root volume (gp3, DeleteOnTermination: true)
- ✅ 2 persistent Elastic IPs
- ✅ SSH Key Pair (or use an existing one)

**Generated files:**
- `aws-config.env` - Configuration variables (⚠️ DO NOT COMMIT)
- `aws-infrastructure.txt` - Infrastructure documentation

### 2. manage-aws-instances.sh

Manages the lifecycle of created instances.

**Requirement:**
The `aws-config.env` file generated by `create-aws-infra.sh` must exist

**Commands:**

#### Status - View instance status
```bash
./manage-aws-instances.sh status
```

Shows:
- Status of each instance (running/stopped/terminated)
- Public IPs
- SSH commands to connect

#### Start - Start instances
```bash
./manage-aws-instances.sh start
```

- Starts stopped instances
- Waits until they are running
- Gets new public IPs
- Updates `aws-config.env` with new IPs

**Note:** Public IPs change every time you start a stopped instance (unless you use Elastic IPs).

#### Stop - Stop instances
```bash
./manage-aws-instances.sh stop
```

- Stops running instances
- Waits until they are stopped
- Stopped instances do NOT generate compute costs (only storage)

**Ideal for:** Saving costs when you're not using the instances but want to keep them.

#### Destroy - Destroy infrastructure
```bash
./manage-aws-instances.sh destroy
```

**⚠️ CAREFUL:** This operation is PERMANENT and IRREVERSIBLE.

**Process:**
1. Requests confirmation (you must type "yes")
2. Requests second confirmation (you must type "DESTROY")
3. Terminates EC2 instances
4. **Automatically releases Elastic IPs** (avoids charges)
5. **Detects orphaned EBS volumes** and asks if you want to delete them
6. Asks if you want to delete Security Groups and Key Pair
7. **Cleans up Security Groups with retry system**

**Resources deleted:**
- ✅ EC2 instances (permanently terminated)
- ✅ Elastic IPs (automatically released)
- ✅ Orphaned EBS volumes (optional, it asks you)
- ✅ Security Groups (optional, with retries)
- ✅ Key Pair in AWS (optional)

**NOT deleted:**
- ❌ Local file `~/.ssh/{KEY_NAME}.pem` (you must delete it manually)
- ❌ Files `aws-config.env` and `aws-infrastructure.txt` (you must delete them manually)

## Typical Workflow

### Initial Setup
```bash
# 1. Create infrastructure
./create-aws-infra.sh

# 2. Verify everything was created correctly
./manage-aws-instances.sh status

# 3. Connect via SSH
ssh -i ~/.ssh/peer-observer-key.pem ubuntu@<NODE_IP>
ssh -i ~/.ssh/peer-observer-key.pem ubuntu@<WEB_IP>
```

### Daily Usage
```bash
# Start instances
./manage-aws-instances.sh start

# Work with the instances...

# Stop to save costs
./manage-aws-instances.sh stop
```

### Final Cleanup
```bash
# Destroy everything
./manage-aws-instances.sh destroy

# Delete local sensitive files
rm aws-config.env aws-infrastructure.txt
rm ~/.ssh/peer-observer-key.pem  # If you don't need it anymore
```

## Estimated Costs

| Resource | Running | Stopped | Notes |
|---------|---------|---------|-------|
| t3.large (node01) | ~$0.08/h (~$58/month) | $0 | Only compute when running |
| t3.medium (web01) | ~$0.04/h (~$29/month) | $0 | Only compute when running |
| EBS 1000 GB (gp3) | ~$80/month | ~$80/month | Permanent |
| EBS 50 GB (gp3) | ~$4/month | ~$4/month | Permanent |
| EBS 100 GB (gp3) | ~$8/month | ~$8/month | Permanent |
| Elastic IP (associated) | $0 | $0 | Free if associated |
| Elastic IP (unassociated) | ~$3.6/month | ~$3.6/month | Delete with destroy! |

**Approximate total:**
- Running: ~$180/month (with everything running 24/7)
- Stopped: ~$92/month (storage only)

**Saving strategies:**
1. Use `stop` when not using instances → ~50% savings
2. Reduce Bitcoin volume size if you don't need the entire blockchain
3. Use t3 instances with credits for burst performance
4. Consider Reserved Instances if usage is 24/7 for 1-3 years

## Troubleshooting

### Error: "Could not delete security group"
**Cause:** Network interfaces are still being released

**Solution:**
- The script tries 3 times with 5 seconds between attempts
- If it still fails, wait 5-10 more minutes and delete manually:
  ```bash
  aws ec2 delete-security-group --region us-east-1 --group-id sg-xxxxx
  ```

### Error: "Elastic IP could not be released"
**Cause:** The EIP is still associated with the instance

**Solution:**
- Disassociate manually first:
  ```bash
  aws ec2 disassociate-address --region us-east-1 --association-id eipassoc-xxxxx
  aws ec2 release-address --region us-east-1 --allocation-id eipalloc-xxxxx
  ```

### Public IPs change after stop/start
**Cause:** AWS reassigns dynamic public IPs on restart

**Solutions:**
- Use Elastic IPs (the `create-aws-infra.sh` script already configures them)
- Verify that Elastic IPs are correctly associated

### Cannot connect via SSH
**Check:**
1. Instance is in "running" state
2. Security Group allows SSH (port 22) from your IP
3. You have the correct .pem file
4. .pem file permissions are 400 (`chmod 400 ~/.ssh/peer-observer-key.pem`)
5. You're using the correct user (ubuntu for Ubuntu AMIs)

```bash
# Check status
./manage-aws-instances.sh status

# Check permissions
ls -l ~/.ssh/peer-observer-key.pem  # Should show -r--------

# Fix permissions if necessary
chmod 400 ~/.ssh/peer-observer-key.pem
```

## Security

**⚠️ NEVER commit these files:**
- `aws-config.env` - Contains IDs and sensitive configuration
- `aws-infrastructure.txt` - Contains IPs and public details
- `*.pem` - SSH private keys
- `*.bak` - Backups that may contain sensitive info

**Best practices:**
- Rotate SSH keys periodically
- Use MFA on your AWS account
- Limit Security Group rules to specific IPs (not 0.0.0.0/0 for SSH)
- Enable CloudTrail for auditing
- Review AWS Cost Explorer regularly

## Additional Resources

- [AWS CLI Documentation](https://docs.aws.amazon.com/cli/)
- [EC2 Instance Types](https://aws.amazon.com/ec2/instance-types/)
- [EBS Pricing](https://aws.amazon.com/ebs/pricing/)
- [AWS Free Tier](https://aws.amazon.com/free/)

---

To return to the main documentation: [README.md](../README.md)
